# Next.js è¿ç§»å®Œæˆæ–‡æ¡£

## ðŸ“‹ è¿ç§»æ¦‚è¿°

é¡¹ç›®å·²æˆåŠŸä»Ž Vercel Serverless Functions è¿ç§»åˆ° Next.js æ¡†æž¶ï¼Œè§£å†³äº† nodemailer ä¾èµ–é—®é¢˜ã€‚

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. æ¡†æž¶è¿ç§»
- âœ… å®‰è£… Next.js 14.2.5ã€React 18.3.1ã€React-DOM 18.3.1
- âœ… åˆ›å»º `app` ç›®å½•ç»“æž„ï¼ˆNext.js App Routerï¼‰
- âœ… é…ç½® TypeScript æ”¯æŒ
- âœ… é…ç½® `next.config.js` å’Œ `tsconfig.json`

### 2. é™æ€æ–‡ä»¶è¿ç§»
- âœ… å°† `index.html`ã€`payment-integration.html`ã€`payment-result.html` ç§»åˆ° `public/` ç›®å½•
- âœ… å°† `script.js`ã€`styles.css` ç§»åˆ° `public/` ç›®å½•
- âœ… å°† `images/` ç›®å½•ç§»åˆ° `public/images/`
- âœ… Next.js è‡ªåŠ¨æä¾›é™æ€æ–‡ä»¶æœåŠ¡

### 3. API è·¯ç”±è¿ç§»
æ‰€æœ‰ API è·¯ç”±å·²è¿ç§»åˆ° Next.js API Routes æ ¼å¼ï¼š

#### `/app/api/payment-notify/route.ts`
- å¤„ç† PayQixiang æ”¯ä»˜å¼‚æ­¥é€šçŸ¥
- éªŒè¯ç­¾å
- ä¿å­˜è®¢å•åˆ°é£žä¹¦è¡¨æ ¼
- **å‘é€ç¡®è®¤é‚®ä»¶ï¼ˆåŒ…å«å½•éŸ³é™„ä»¶ï¼‰**
- æ”¯æŒå½•éŸ³æ–‡ä»¶ Base64 è§£ç 

#### `/app/api/payment-create/route.ts`
- åˆ›å»ºæ”¯ä»˜è®¢å•
- è°ƒç”¨ PayQixiang API
- æ”¯æŒå½•éŸ³æ–‡ä»¶æ•°æ®ä¼ é€’

#### `/app/api/payment-query/route.ts`
- æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€
- è¿”å›žè®¢å•ä¿¡æ¯

#### `/app/api/check-env/route.ts`
- æ£€æŸ¥çŽ¯å¢ƒå˜é‡é…ç½®
- ç”¨äºŽè¯Šæ–­å’Œè°ƒè¯•

### 4. ä¾èµ–åº“è¿ç§»
- âœ… å°† `api/lib/feishu.js` è¿ç§»åˆ° `lib/feishu.ts`
- âœ… **nodemailer çŽ°åœ¨å¯ä»¥æ­£å¸¸å·¥ä½œ**
- âœ… form-dataã€busboy ç­‰ä¾èµ–æ­£å¸¸å·¥ä½œ

### 5. æ¸…ç†å·¥ä½œ
- âœ… åˆ é™¤æ—§çš„ `api/` ç›®å½•
- âœ… åˆ é™¤ `vercel.json` é…ç½®æ–‡ä»¶ï¼ˆNext.js ä¸éœ€è¦ï¼‰

## ðŸŽ¯ å…³é”®ä¼˜åŠ¿

### è§£å†³çš„é—®é¢˜
1. **nodemailer ä¾èµ–é—®é¢˜å½»åº•è§£å†³**
   - ä¹‹å‰ï¼šVercel Serverless Functions æ— æ³•æ­£ç¡®å®‰è£… nodemailer
   - çŽ°åœ¨ï¼šNext.js è‡ªåŠ¨å¤„ç†æ‰€æœ‰ä¾èµ–æ‰“åŒ…ï¼Œnodemailer æ­£å¸¸å·¥ä½œ

2. **æ›´å¥½çš„å¼€å‘ä½“éªŒ**
   - TypeScript æ”¯æŒå’Œç±»åž‹æ£€æŸ¥
   - çƒ­é‡è½½ï¼ˆHot Module Replacementï¼‰
   - æ›´å¥½çš„é”™è¯¯æç¤ºå’Œè°ƒè¯•

3. **Vercel åŽŸç”Ÿæ”¯æŒ**
   - Next.js æ˜¯ Vercel çš„é¦–é€‰æ¡†æž¶
   - éƒ¨ç½²æ›´ç¨³å®šã€æž„å»ºæ›´å¿«
   - è‡ªåŠ¨ä¼˜åŒ–å’Œç¼“å­˜

### ä¿æŒçš„åŠŸèƒ½
- âœ… æ‰€æœ‰é™æ€ HTML é¡µé¢æ­£å¸¸å·¥ä½œ
- âœ… æ‰€æœ‰ CSS æ ·å¼ä¿æŒä¸å˜
- âœ… æ‰€æœ‰ JavaScript åŠŸèƒ½æ­£å¸¸
- âœ… æ”¯ä»˜æµç¨‹å®Œæ•´
- âœ… é£žä¹¦é›†æˆæ­£å¸¸
- âœ… å½•éŸ³æ–‡ä»¶ä¼ é€’åŠŸèƒ½å®Œæ•´

## ðŸ“‚ æ–°çš„é¡¹ç›®ç»“æž„

```
soundbox-story/
â”œâ”€â”€ app/                          # Next.js App Router
â”‚   â”œâ”€â”€ api/                      # API Routes
â”‚   â”‚   â”œâ”€â”€ payment-notify/
â”‚   â”‚   â”‚   â””â”€â”€ route.ts         # æ”¯ä»˜é€šçŸ¥ + é‚®ä»¶å‘é€
â”‚   â”‚   â”œâ”€â”€ payment-create/
â”‚   â”‚   â”‚   â””â”€â”€ route.ts         # åˆ›å»ºæ”¯ä»˜
â”‚   â”‚   â”œâ”€â”€ payment-query/
â”‚   â”‚   â”‚   â””â”€â”€ route.ts         # æŸ¥è¯¢æ”¯ä»˜
â”‚   â”‚   â””â”€â”€ check-env/
â”‚   â”‚       â””â”€â”€ route.ts         # çŽ¯å¢ƒå˜é‡æ£€æŸ¥
â”‚   â”œâ”€â”€ layout.tsx               # æ ¹å¸ƒå±€
â”‚   â””â”€â”€ page.tsx                 # é¦–é¡µï¼ˆé‡å®šå‘åˆ° /index.htmlï¼‰
â”œâ”€â”€ lib/
â”‚   â””â”€â”€ feishu.ts                # é£žä¹¦è¡¨æ ¼é›†æˆ
â”œâ”€â”€ public/                       # é™æ€æ–‡ä»¶
â”‚   â”œâ”€â”€ index.html               # é¦–é¡µ
â”‚   â”œâ”€â”€ payment-integration.html # æ”¯ä»˜é¡µé¢
â”‚   â”œâ”€â”€ payment-result.html      # æ”¯ä»˜ç»“æžœé¡µé¢
â”‚   â”œâ”€â”€ script.js                # å‰ç«¯è„šæœ¬
â”‚   â”œâ”€â”€ styles.css               # æ ·å¼è¡¨
â”‚   â””â”€â”€ images/                  # å›¾ç‰‡èµ„æº
â”‚       â”œâ”€â”€ baba.wav
â”‚       â”œâ”€â”€ mama.wav
â”‚       â””â”€â”€ wechat-qrcode.png
â”œâ”€â”€ scripts/                      # æµ‹è¯•è„šæœ¬
â”œâ”€â”€ next.config.js               # Next.js é…ç½®
â”œâ”€â”€ tsconfig.json                # TypeScript é…ç½®
â”œâ”€â”€ package.json                 # ä¾èµ–é…ç½®
â””â”€â”€ .gitignore                   # Git å¿½ç•¥æ–‡ä»¶

å·²åˆ é™¤ï¼š
â”œâ”€â”€ api/                         # âŒ æ—§çš„ Serverless Functions
â””â”€â”€ vercel.json                  # âŒ æ—§çš„ Vercel é…ç½®
```

## ðŸ”§ çŽ¯å¢ƒå˜é‡é…ç½®

éœ€è¦åœ¨ Vercel é…ç½®ä»¥ä¸‹çŽ¯å¢ƒå˜é‡ï¼š

### SMTP é‚®ä»¶é…ç½®ï¼ˆ4ä¸ªï¼‰
```
SMTP_HOST = smtp.sohu.com
SMTP_PORT = 25
SMTP_USER = 13001274087@sohu.com
SMTP_PASS = 3RWJBEFLXTHK
```

### é£žä¹¦ API é…ç½®ï¼ˆ5ä¸ªï¼‰
```
FEISHU_APP_ID = cli_a834914dcf6c500d
FEISHU_APP_SECRET = LLweMTeb33fFvJ4pDec9LhHfEtswX1L1
FEISHU_BASE_URL = https://open.feishu.cn/open-apis
FEISHU_BASE_TOKEN = BwfBbSdPmaXjuls14RZcA22znUY
FEISHU_TABLE_ID = tblU7uysGphfPxab
```

## ðŸ§ª æµ‹è¯•æŒ‡å—

### 1. æµ‹è¯•é‚®ä»¶å‘é€åŠŸèƒ½

```bash
curl -X POST https://story.66668888.cloud/api/payment-notify \
  -H "Content-Type: application/json" \
  -d '{
    "pid": "2999",
    "trade_no": "TEST1768216000000",
    "out_trade_no": "SB_TEST_001",
    "type": "alipay",
    "name": "ä½“éªŒåŒ…",
    "money": "9.9",
    "trade_status": "TRADE_SUCCESS",
    "param": "{\"childName\":\"æµ©æµ©\",\"voiceType\":\"çˆ¸çˆ¸\",\"email\":\"1543827@qq.com\",\"productName\":\"ä½“éªŒåŒ…\"}",
    "sign": "YOUR_CALCULATED_SIGN",
    "sign_type": "MD5"
  }'
```

**é¢„æœŸç»“æžœï¼š**
- API è¿”å›ž `success`
- é‚®ç®± `1543827@qq.com` æ”¶åˆ°ç¡®è®¤é‚®ä»¶
- é£žä¹¦è¡¨æ ¼æœ‰æ–°è®¢å•è®°å½•

### 2. æµ‹è¯•çŽ¯å¢ƒå˜é‡

```bash
curl https://story.66668888.cloud/api/check-env
```

**é¢„æœŸç»“æžœï¼š**
- æ‰€æœ‰çŽ¯å¢ƒå˜é‡æ˜¾ç¤º "âœ… å·²é…ç½®"

### 3. æµ‹è¯•å®Œæ•´æ”¯ä»˜æµç¨‹

1. è®¿é—® https://story.66668888.cloud/
2. é€‰æ‹©äº§å“ï¼ˆä¾‹å¦‚ï¼šä½“éªŒåŒ… Â¥9.9ï¼‰
3. å¡«å†™ä¿¡æ¯å¹¶å½•éŸ³
4. ç‚¹å‡»"ç¡®è®¤è®¢å•ï¼Œå‰å¾€æ”¯ä»˜"
5. å®Œæˆæ”¯ä»˜
6. æ£€æŸ¥ï¼š
   - æ”¯ä»˜ç»“æžœé¡µé¢æ˜¾ç¤ºè®¢å•ä¿¡æ¯
   - é‚®ç®±æ”¶åˆ°ç¡®è®¤é‚®ä»¶ï¼ˆå¸¦å½•éŸ³é™„ä»¶ï¼‰
   - é£žä¹¦è¡¨æ ¼æœ‰è®¢å•è®°å½•ï¼ˆå¸¦å½•éŸ³é™„ä»¶ï¼‰

## ðŸ“Š åŠŸèƒ½æ¸…å•

### âœ… å·²éªŒè¯æ­£å¸¸çš„åŠŸèƒ½
- [x] é¦–é¡µè®¿é—®å’Œæ˜¾ç¤º
- [x] éŸ³é¢‘æ’­æ”¾å™¨ï¼ˆbaba.wavã€mama.wavï¼‰
- [x] äº§å“é€‰æ‹©å’Œè®¢å•è¡¨å•
- [x] å½•éŸ³åŠŸèƒ½
- [x] æ”¯ä»˜åˆ›å»º
- [x] æ”¯ä»˜é€šçŸ¥å¤„ç†
- [x] é£žä¹¦è¡¨æ ¼ä¿å­˜
- [x] **é‚®ä»¶å‘é€ï¼ˆåŒ…å«é™„ä»¶ï¼‰** âœ¨ æ–°ä¿®å¤
- [x] æ”¯ä»˜ç»“æžœé¡µé¢

### ðŸŽ™ï¸ å½•éŸ³æ–‡ä»¶ä¼ é€’æµç¨‹
1. ç”¨æˆ·åœ¨é¦–é¡µå½•éŸ³ â†’ Blob å¯¹è±¡
2. è½¬æ¢ä¸º Base64 ç¼–ç 
3. é€šè¿‡ localStorage ä¼ é€’ç»™æ”¯ä»˜é¡µé¢
4. æ”¯ä»˜åˆ›å»ºæ—¶åŒ…å«åœ¨ `param` å‚æ•°ä¸­
5. æ”¯ä»˜æˆåŠŸåŽï¼š
   - Base64 è§£ç ä¸º Buffer
   - ä½œä¸ºé‚®ä»¶é™„ä»¶å‘é€ âœ…
   - ä¸Šä¼ åˆ°é£žä¹¦äº‘ç›˜å¹¶ä¿å­˜ âœ…

## ðŸš€ éƒ¨ç½²è¯´æ˜Ž

### è‡ªåŠ¨éƒ¨ç½²
- æŽ¨é€åˆ° GitHub `main` åˆ†æ”¯ä¼šè‡ªåŠ¨è§¦å‘ Vercel éƒ¨ç½²
- éƒ¨ç½²æ—¶é—´çº¦ 1-2 åˆ†é’Ÿ
- Next.js ä¼šè‡ªåŠ¨ä¼˜åŒ–å’Œæž„å»º

### æ‰‹åŠ¨éƒ¨ç½²
```bash
# æœ¬åœ°å¼€å‘
npm run dev

# æž„å»ºç”Ÿäº§ç‰ˆæœ¬
npm run build

# å¯åŠ¨ç”Ÿäº§æœåŠ¡å™¨
npm run start
```

## ðŸ“ æ³¨æ„äº‹é¡¹

1. **çŽ¯å¢ƒå˜é‡å¿…é¡»é…ç½®**
   - åœ¨ Vercel é¡¹ç›®è®¾ç½®ä¸­é…ç½®æ‰€æœ‰ 9 ä¸ªçŽ¯å¢ƒå˜é‡
   - é…ç½®åŽéœ€è¦é‡æ–°éƒ¨ç½²

2. **é™æ€æ–‡ä»¶è®¿é—®**
   - æ‰€æœ‰é™æ€æ–‡ä»¶é€šè¿‡ `/` è·¯å¾„è®¿é—®
   - ä¾‹å¦‚ï¼š`/index.html`ã€`/script.js`ã€`/images/baba.wav`

3. **API è·¯ç”±**
   - æ‰€æœ‰ API è·¯ç”±åœ¨ `/api/` è·¯å¾„ä¸‹
   - ä¾‹å¦‚ï¼š`/api/payment-notify`ã€`/api/payment-create`

4. **å½•éŸ³æ–‡ä»¶å¤§å°é™åˆ¶**
   - Vercel Serverless Functions æœ‰ 4.5MB çš„è¯·æ±‚ä½“é™åˆ¶
   - å½•éŸ³æ–‡ä»¶å»ºè®®æŽ§åˆ¶åœ¨ 10 ç§’ä»¥å†…

## ðŸŽ‰ è¿ç§»æˆåŠŸï¼

é¡¹ç›®å·²æˆåŠŸè¿ç§»åˆ° Next.jsï¼Œæ‰€æœ‰åŠŸèƒ½æ­£å¸¸å·¥ä½œã€‚nodemailer ä¾èµ–é—®é¢˜å·²å½»åº•è§£å†³ï¼Œé‚®ä»¶å‘é€åŠŸèƒ½çŽ°åœ¨å¯ä»¥æ­£å¸¸ä½¿ç”¨ã€‚

---

**è¿ç§»æ—¥æœŸï¼š** 2026-01-12  
**Next.js ç‰ˆæœ¬ï¼š** 14.2.5  
**Node.js ç‰ˆæœ¬ï¼š** >=18.0.0
