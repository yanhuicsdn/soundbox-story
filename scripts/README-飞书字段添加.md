# 飞书表格字段添加说明

## 📋 概述

这个脚本用于在飞书多维表格中自动添加故事生成相关的字段。

## 🎯 添加的字段

### 基础订单字段（如果不存在）
- **订单号** - 文本
- **交易号** - 文本
- **支付金额** - 数字
- **商品名称** - 文本
- **宝宝名字** - 文本
- **声音类型** - 文本
- **用户邮箱** - 文本
- **支付状态** - 文本
- **支付时间** - 日期
- **创建时间** - 日期
- **录音文件** - 附件

### 故事生成字段（新增）
- **任务ID** - 文本（存储故事生成任务的 task_id）
- **故事状态** - 单选（生成中/生成完成/生成失败）
- **下载链接** - URL（故事下载地址）
- **错误信息** - 文本（生成失败时的错误信息）

## 🚀 使用方法

### 方法 1: 使用 npx tsx（推荐）

```bash
# 在项目根目录运行
npx tsx scripts/add-feishu-fields.ts
```

### 方法 2: 使用 Node.js

```bash
# 1. 先编译 TypeScript
npx tsc scripts/add-feishu-fields.ts --outDir scripts/dist

# 2. 运行编译后的文件
node scripts/dist/add-feishu-fields.js
```

### 方法 3: 添加到 package.json

在 `package.json` 中添加脚本：

```json
{
  "scripts": {
    "add-fields": "tsx scripts/add-feishu-fields.ts"
  }
}
```

然后运行：

```bash
npm run add-fields
```

## ⚙️ 前置条件

### 1. 环境变量配置

确保 `.env` 文件中配置了以下变量：

```bash
# 飞书应用配置
FEISHU_APP_ID=cli_xxxxxxxxxxxxx
FEISHU_APP_SECRET=xxxxxxxxxxxxxxxxxxxxx

# 多维表格配置
FEISHU_BASE_TOKEN=bascnxxxxxxxxxxxxx
FEISHU_TABLE_ID=tblxxxxxxxxxxxxx
```

### 2. 飞书应用权限

确保你的飞书应用有以下权限：
- ✅ 查看、编辑多维表格
- ✅ 上传文件到多维表格

### 3. 应用已添加到表格

确保飞书应用已经添加到目标多维表格中。

## 📊 运行示例

### 成功运行的输出：

```
========================================
  在飞书表格中添加字段
========================================

✅ 环境变量检查通过

将添加以下字段到飞书表格：

基础字段：
  - 订单号 (文本)
  - 交易号 (文本)
  ...

故事生成字段：
  - 任务ID (文本)
  - 故事状态 (单选: 生成中/生成完成/生成失败)
  - 下载链接 (URL)
  - 错误信息 (文本)

开始创建字段...

📋 开始创建飞书表格字段...
⚠️ 字段 "订单号" 已存在，跳过
⚠️ 字段 "交易号" 已存在，跳过
...
✅ 字段 "任务ID" 创建成功
✅ 字段 "故事状态" 创建成功
✅ 字段 "下载链接" 创建成功
✅ 字段 "错误信息" 创建成功
✅ 字段创建完成，共创建 4 个字段

========================================
  字段添加完成！
========================================

✅ 成功创建 4 个新字段

下一步：
1. 登录飞书，查看多维表格确认字段已添加
2. 检查"故事状态"字段的选项是否正确
3. 测试订单系统与故事生成API的集成
```

## ❌ 常见错误

### 错误 1: 缺少环境变量

```
❌ 缺少必要的环境变量:
   - FEISHU_APP_ID
   - FEISHU_APP_SECRET
```

**解决方法**: 在 `.env` 文件中添加缺失的环境变量

### 错误 2: 权限不足

```
❌ 保存到飞书表格失败: 权限不足
```

**解决方法**: 
1. 检查飞书应用是否有"多维表格"权限
2. 确认应用已添加到目标表格

### 错误 3: 表格不存在

```
❌ 保存到飞书表格失败: app_token 或 table_id 无效
```

**解决方法**: 检查 `FEISHU_BASE_TOKEN` 和 `FEISHU_TABLE_ID` 是否正确

## 🔍 验证字段是否添加成功

1. 登录飞书
2. 打开对应的多维表格
3. 查看表格列，应该能看到新增的字段：
   - 任务ID
   - 故事状态
   - 下载链接
   - 错误信息

4. 点击"故事状态"字段，确认有以下选项：
   - 生成中
   - 生成完成
   - 生成失败

## 📝 代码说明

### 字段类型对照表

| 飞书字段类型 | type 值 | 说明 |
|-------------|---------|------|
| 文本 | 1 | 单行文本 |
| 数字 | 2 | 数值 |
| 单选 | 3 | 下拉单选 |
| 日期 | 5 | 日期时间 |
| URL | 15 | 超链接 |
| 附件 | 17 | 文件附件 |

### 单选字段配置

```typescript
{
  field_name: '故事状态',
  type: 3,
  property: {
    options: [
      { name: '生成中' },
      { name: '生成完成' },
      { name: '生成失败' }
    ]
  }
}
```

## 🔗 相关文件

- **字段定义**: `lib/feishu.ts` 中的 `createTableFields()` 函数
- **更新函数**: `lib/feishu.ts` 中的 `updateTaskStatus()` 函数
- **回调接口**: `app/api/story-callback/route.ts`

## 💡 提示

1. **脚本是幂等的**: 多次运行不会重复创建字段，已存在的字段会被跳过
2. **字段顺序**: 字段会按照定义的顺序添加到表格中
3. **字段名称**: 字段名称必须与代码中使用的名称完全一致（包括中文）

## 🎉 完成后

字段添加成功后，系统就可以：
1. ✅ 在支付成功后保存 `taskId` 到订单
2. ✅ 在故事生成时更新状态为"生成中"
3. ✅ 在生成完成后更新状态为"生成完成"并保存下载链接
4. ✅ 在生成失败后更新状态为"生成失败"并保存错误信息

---

**如有问题，请查看日志或联系技术支持。**
